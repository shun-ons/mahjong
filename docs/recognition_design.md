# **設計書: `tile_detector.py`**

## **1. 概要 (Overview)**

このファイルは、画像データを受け取り、YOLOv8などの学習済みモデルを用いて画像内に存在する麻雀牌を検出する機能を提供する。検出結果を、アプリケーション全体で利用しやすい統一形式（文字列のリスト）に変換して返すことを責務とする。

## **2. 依存関係 (Dependencies)**

| 種類 | ライブラリ | 目的 |
|:--- |:--- |:--- |
| **外部** | `torch` | YOLOモデルの実行 |
| **外部** | `numpy` | 画像データの前処理、数値計算 |
| **外部** | `PIL` (Pillow) | 画像データの読み込みと操作 |

## **3. 関数定義 (Function Definition)**

このファイルは、主に単一の関数を外部に提供する。

## **`detect_tiles(image_data: bytes) -> list[str]`**

- **機能説明:** 画像のバイナリデータを受け取り、含まれる牌を検出し、指定された形式の文字列リストとして返す。
- **引数:** `image_data` (`bytes`): 画像ファイルのバイナリデータ。`request.files['image'].read()`などで取得したデータを想定。
- **返り値:**
  - `list[str]`: 検出された牌の文字列リスト。例: `['1m', '1m', '2p', '5s', '7z']`
  - 返されるリストは、検出順でありソートされていない。
- **送出する例外:**
  - `ValueError`: 画像データとして認識できない不正なデータが渡された場合。
  - `NoTilesDetectedError` (独自定義): 画像は正常だが、信頼できる牌が一つも検出できなかった場合。

---

## **4. 処理フロー (Processing Flow)**

1. **モデル読み込み:**
    - 初回実行時に、学習済みのYOLOモデル（例: `models/mahjong_yolo.pt`）をメモリに読み込んでおく。
2. **入力受付:**
    - 引数として`image_data` (bytes) を受け取る。
3. **画像変換:**
    - 受け取ったバイナリデータをPillowやOpenCVを使い、モデルが処理できる画像オブジェクト（例: NumPy配列）に変換する。
4. **推論実行:**
    - 画像オブジェクトをYOLOモデルに渡し、推論（検出処理）を実行する。
5. **結果解析:**
    - モデルからの生（なま）の検出結果（クラスID、信頼度、バウンディングボックス）を取得する。
    - 事前に設定した信頼度の閾値（いきち）に満たない検出結果は破棄する。
6. **形式変換:**
    - 信頼できる各検出結果について、**クラスID**を**指定の文字列**にマッピングする。（下記のマッピング表を参照）
7. **リスト生成:**
    - 変換した文字列をリストに追加していく。
8. **返却:**
    - 最終的に生成された文字列のリストを返す。一つも検出できなかった場合は`NoTilesDetectedError`を送出する。

---

## **5. クラスIDから文字列への対応表 (Mapping Table)**

YOLOモデルの学習時に定義したクラスIDと、この関数が返す文字列の対応関係は以下の通りとする。

| クラスID (Class ID) | 返却文字列 (String) | 牌の種類 |
|:---|:---|:---|
| 0 - 8 | `1m` - `9m` | 萬子 (マンズ) |
| 9 - 17 | `1p` - `9p` | 筒子 (ピンズ) |
| 18 - 26 | `1s` - `9s` | 索子 (ソーズ) |
| 27 | `1z` | 東 (トン) |
| 28 | `2z` | 南 (ナン) |
| 29 | `3z` | 西 (シャー) |
| 30 | `4z` | 北 (ペー) |
| 31 | `5z` | 白 (ハク) |
| 32 | `6z` | 發 (ハツ) |
| 33 | `7z` | 中 (チュン) |
| (34以降) | `aka5m` など | (任意) 赤ドラを区別する場合は、追加のIDを割り当てる |